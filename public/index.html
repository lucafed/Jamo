import { useMemo, useState } from "react";
import styles from "../styles/Home.module.css";

const CATEGORIES = [
  { id: "ovunque", label: "Ovunque (sorpresa)", emoji: "üé≤" },
  { id: "chicca", label: "Chicche", emoji: "‚ú®" },
  { id: "borgo", label: "Borghi", emoji: "üèòÔ∏è" },
  { id: "mare", label: "Mare", emoji: "üåä" },
  { id: "montagna", label: "Montagna", emoji: "üèîÔ∏è" },
  { id: "natura", label: "Natura", emoji: "üåø" },
  { id: "storia", label: "Storia", emoji: "üèõÔ∏è" },
  { id: "relax", label: "Relax", emoji: "üßñ" },
  { id: "bambini", label: "Family", emoji: "üë®‚Äçüë©‚Äçüëß‚Äçüë¶" },
];

const QUICK_TIMES = [30, 60, 90, 120, 180, 240];

export default function Home() {
  const [originLabel, setOriginLabel] = useState("L'Aquila");
  const [originLat, setOriginLat] = useState(42.3498);
  const [originLon, setOriginLon] = useState(13.3995);

  const [minutes, setMinutes] = useState(120);
  const [category, setCategory] = useState("ovunque");
  const [style, setStyle] = useState("gems"); // gems | known

  const [loading, setLoading] = useState(false);
  const [top, setTop] = useState(null);
  const [alts, setAlts] = useState([]);
  const [msg, setMsg] = useState("");

  const canSearch = useMemo(() => {
    return Number.isFinite(Number(originLat)) && Number.isFinite(Number(originLon)) && minutes > 0;
  }, [originLat, originLon, minutes]);

  async function findIdea() {
    if (!canSearch) return;
    setLoading(true);
    setMsg("");
    setTop(null);
    setAlts([]);

    try {
      const r = await fetch("/api/jamo", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          origin: { lat: Number(originLat), lon: Number(originLon), label: originLabel },
          minutes: Number(minutes),
          category,
          style,
          visitedIds: [],
          weekIds: [],
        }),
      });

      const data = await r.json();
      if (!r.ok) throw new Error(data?.error || "Errore API");

      if (!data?.top) {
        setMsg(data?.message || "Nessuna meta trovata. Prova ad aumentare il tempo o cambia categoria.");
        return;
      }

      setTop(data.top);
      setAlts(Array.isArray(data.alternatives) ? data.alternatives : []);
    } catch (e) {
      setMsg(String(e?.message || e));
    } finally {
      setLoading(false);
    }
  }

  function useMyLocation() {
    if (!navigator.geolocation) {
      setMsg("Geolocalizzazione non supportata dal browser.");
      return;
    }
    setMsg("");
    navigator.geolocation.getCurrentPosition(
      (pos) => {
        setOriginLabel("La mia posizione");
        setOriginLat(pos.coords.latitude);
        setOriginLon(pos.coords.longitude);
      },
      () => setMsg("Impossibile ottenere la posizione. Inserisci lat/lon manualmente.")
    );
  }

  return (
    <div className={styles.page}>
      <header className={styles.hero}>
        <div className={styles.brand}>
          <div className={styles.logo}>W</div>
          <div>
            <div className={styles.title}>What?f Trips</div>
            <div className={styles.subtitle}>AUTO-ONLY ‚Ä¢ mete bellissime ‚Ä¢ zero casino</div>
          </div>
        </div>

        <h1 className={styles.h1}>
          Dimmi <span>da dove parti</span> e <span>quanto tempo hai</span>.
          <br />
          Io ti tiro fuori la meta perfetta.
        </h1>

        <div className={styles.chipsRow}>
          <span className={styles.chip}>üöó Solo auto</span>
          <span className={styles.chip}>‚ú® Chicche + classiche</span>
          <span className={styles.chip}>‚è±Ô∏è Tempo realistico</span>
          <span className={styles.chip}>üìç Abruzzo (prima macro)</span>
        </div>
      </header>

      <main className={styles.main}>
        <section className={styles.panel}>
          <div className={styles.panelTitle}>Partenza</div>

          <div className={styles.grid2}>
            <label className={styles.field}>
              <span>Citt√† / Etichetta</span>
              <input value={originLabel} onChange={(e) => setOriginLabel(e.target.value)} placeholder="Es. L'Aquila" />
            </label>

            <button className={styles.geoBtn} onClick={useMyLocation} type="button">
              üìç Usa la mia posizione
            </button>

            <label className={styles.field}>
              <span>Latitudine</span>
              <input value={originLat} onChange={(e) => setOriginLat(e.target.value)} inputMode="decimal" />
            </label>

            <label className={styles.field}>
              <span>Longitudine</span>
              <input value={originLon} onChange={(e) => setOriginLon(e.target.value)} inputMode="decimal" />
            </label>
          </div>
        </section>

        <section className={styles.panel}>
          <div className={styles.panelTitle}>Il tuo tempo</div>

          <div className={styles.timeRow}>
            {QUICK_TIMES.map((t) => (
              <button
                key={t}
                className={`${styles.timeBtn} ${minutes === t ? styles.timeBtnActive : ""}`}
                onClick={() => setMinutes(t)}
                type="button"
              >
                {t} min
              </button>
            ))}
          </div>

          <label className={styles.field}>
            <span>Oppure scegli preciso (minuti)</span>
            <input
              type="number"
              min="10"
              max="600"
              value={minutes}
              onChange={(e) => setMinutes(Number(e.target.value))}
            />
          </label>
        </section>

        <section className={styles.panel}>
          <div className={styles.panelTitle}>Cosa ti va?</div>

          <div className={styles.catGrid}>
            {CATEGORIES.map((c) => (
              <button
                key={c.id}
                className={`${styles.catBtn} ${category === c.id ? styles.catBtnActive : ""}`}
                onClick={() => setCategory(c.id)}
                type="button"
              >
                <span className={styles.catEmoji}>{c.emoji}</span>
                <span>{c.label}</span>
              </button>
            ))}
          </div>

          <div className={styles.toggleRow}>
            <button
              className={`${styles.toggle} ${style === "gems" ? styles.toggleActive : ""}`}
              onClick={() => setStyle("gems")}
              type="button"
            >
              ‚ú® Voglio chicche
            </button>
            <button
              className={`${styles.toggle} ${style === "known" ? styles.toggleActive : ""}`}
              onClick={() => setStyle("known")}
              type="button"
            >
              ‚úÖ Voglio classiche
            </button>
          </div>

          <button className={styles.cta} onClick={findIdea} disabled={!canSearch || loading} type="button">
            {loading ? "Sto scegliendo la meta perfetta..." : "üéØ TROVAMI LA META"}
          </button>

          {msg ? <div className={styles.message}>{msg}</div> : null}
        </section>

        {top ? (
          <section className={styles.resultWrap}>
            <div className={styles.resultTitle}>La tua meta</div>

            <article className={styles.cardTop}>
              <div className={styles.cardHeader}>
                <div className={styles.cardName}>{top.name}</div>
                <div className={styles.badges}>
                  <span className={styles.badge}>üöó ~{top.eta_min} min</span>
                  <span className={styles.badge}>üìè ~{top.distance_km} km</span>
                  <span className={styles.badge}>‚ú® {top.visibility || "bella"}</span>
                </div>
              </div>

              {Array.isArray(top.why) && top.why.length ? (
                <ul className={styles.why}>
                  {top.why.map((x, i) => (
                    <li key={i}>{x}</li>
                  ))}
                </ul>
              ) : null}

              {Array.isArray(top.tags) && top.tags.length ? (
                <div className={styles.tags}>
                  {top.tags.slice(0, 10).map((t) => (
                    <span className={styles.tag} key={t}>{t}</span>
                  ))}
                </div>
              ) : null}
            </article>

            {alts?.length ? (
              <>
                <div className={styles.resultTitle2}>Alternative (se vuoi cambiare vibe)</div>
                <div className={styles.altGrid}>
                  {alts.map((a) => (
                    <article className={styles.cardAlt} key={a.id}>
                      <div className={styles.cardNameSmall}>{a.name}</div>
                      <div className={styles.smallRow}>
                        <span>üöó ~{a.eta_min} min</span>
                        <span>üìè ~{a.distance_km} km</span>
                      </div>
                    </article>
                  ))}
                </div>
              </>
            ) : null}
          </section>
        ) : null}

        <footer className={styles.footer}>
          <div className={styles.footerBox}>
            <div className={styles.footerTitle}>Come funziona (senza fregature)</div>
            <ul className={styles.footerList}>
              <li>Le mete sono in un file offline (macro). Non ‚Äúpeschiamo online‚Äù.</li>
              <li>La stima tempi √® realistica (Abruzzo = montagna = pi√π lenta).</li>
              <li>In futuro: aggiungiamo nuove macro regioni senza toccare il motore.</li>
            </ul>
          </div>
        </footer>
      </main>
    </div>
  );
}
